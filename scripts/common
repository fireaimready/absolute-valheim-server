#!/bin/bash
# =============================================================================
# Common functions and environment setup for Valheim server scripts
# =============================================================================

# -----------------------------------------------------------------------------
# Color output helpers
# -----------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*"
}

# -----------------------------------------------------------------------------
# Path definitions
# -----------------------------------------------------------------------------
STEAMCMD_PATH="/opt/steamcmd"
VALHEIM_SERVER_PATH="/opt/valheim/server"
VALHEIM_SCRIPTS_PATH="/opt/valheim/scripts"
CONFIG_PATH="/config"
WORLDS_PATH="${CONFIG_PATH}/worlds_local"
BACKUPS_PATH="${BACKUPS_DIRECTORY:-${CONFIG_PATH}/backups}"
LOG_PATH="/var/log/valheim"
PID_PATH="/var/run/valheim"

VALHEIM_SERVER_PID="${PID_PATH}/valheim-server.pid"
VALHEIM_APP_ID="896660"
VALHEIM_CLIENT_APP_ID="892970"

# -----------------------------------------------------------------------------
# Server binary path
# -----------------------------------------------------------------------------
VALHEIM_SERVER_BINARY="${VALHEIM_SERVER_PATH}/valheim_server.x86_64"

# -----------------------------------------------------------------------------
# Environment helpers
# -----------------------------------------------------------------------------
get_server_port() {
    echo "${SERVER_PORT:-2456}"
}

get_server_name() {
    echo "${SERVER_NAME:-My Valheim Server}"
}

get_world_name() {
    echo "${WORLD_NAME:-Dedicated}"
}

get_server_password() {
    echo "${SERVER_PASS:-}"
}

is_server_public() {
    local public="${SERVER_PUBLIC:-true}"
    [[ "${public,,}" == "true" || "${public}" == "1" ]]
}

is_crossplay_enabled() {
    local crossplay="${CROSSPLAY:-false}"
    [[ "${crossplay,,}" == "true" || "${crossplay}" == "1" ]]
}

is_update_on_start_enabled() {
    local update="${UPDATE_ON_START:-true}"
    [[ "${update,,}" == "true" || "${update}" == "1" ]]
}

is_backups_enabled() {
    local backups="${BACKUPS_ENABLED:-true}"
    [[ "${backups,,}" == "true" || "${backups}" == "1" ]]
}

# -----------------------------------------------------------------------------
# Process helpers
# -----------------------------------------------------------------------------
is_server_running() {
    if [[ -f "${VALHEIM_SERVER_PID}" ]]; then
        local pid
        pid=$(cat "${VALHEIM_SERVER_PID}")
        if kill -0 "${pid}" 2>/dev/null; then
            return 0
        fi
    fi
    # Also check by process name
    pgrep -f "valheim_server.x86_64" > /dev/null 2>&1
}

get_server_pid() {
    if [[ -f "${VALHEIM_SERVER_PID}" ]]; then
        cat "${VALHEIM_SERVER_PID}"
    else
        pgrep -f "valheim_server.x86_64" 2>/dev/null | head -1
    fi
}

get_player_count() {
    # Parse server status for connected players
    # This is a simplified implementation - actual implementation would query the server
    local status_file="${VALHEIM_SERVER_PATH}/htdocs/status.json"
    if [[ -f "${status_file}" ]]; then
        jq -r '.player_count // 0' "${status_file}" 2>/dev/null || echo "0"
    else
        echo "0"
    fi
}

is_server_idle() {
    local players
    players=$(get_player_count)
    [[ "${players}" == "0" ]]
}

# -----------------------------------------------------------------------------
# Permission helpers
# -----------------------------------------------------------------------------
setup_permissions() {
    local uid="${PUID:-1000}"
    local gid="${PGID:-1000}"
    local umask_val="${PERMISSIONS_UMASK:-022}"

    log_info "Setting up permissions (UID=${uid}, GID=${gid}, UMASK=${umask_val})"

    # Update valheim user/group IDs if different
    if [[ "$(id -u valheim)" != "${uid}" ]]; then
        usermod -u "${uid}" valheim 2>/dev/null || true
    fi
    if [[ "$(id -g valheim)" != "${gid}" ]]; then
        groupmod -g "${gid}" valheim 2>/dev/null || true
    fi

    # Set ownership
    chown -R "${uid}:${gid}" /opt/valheim 2>/dev/null || true
    chown -R "${uid}:${gid}" /config 2>/dev/null || true
    chown -R "${uid}:${gid}" /var/log/valheim 2>/dev/null || true
    chown -R "${uid}:${gid}" /var/run/valheim 2>/dev/null || true

    # Set umask
    umask "${umask_val}"
}

# -----------------------------------------------------------------------------
# Admin list helpers
# -----------------------------------------------------------------------------
setup_admin_lists() {
    log_info "Setting up admin/ban/permitted lists"

    # Admin list
    if [[ -n "${ADMINLIST_IDS}" ]]; then
        log_info "Writing adminlist.txt"
        echo "// Auto-generated admin list" > "${CONFIG_PATH}/adminlist.txt"
        for id in ${ADMINLIST_IDS}; do
            echo "${id}" >> "${CONFIG_PATH}/adminlist.txt"
        done
    fi

    # Banned list
    if [[ -n "${BANNEDLIST_IDS}" ]]; then
        log_info "Writing bannedlist.txt"
        echo "// Auto-generated banned list" > "${CONFIG_PATH}/bannedlist.txt"
        for id in ${BANNEDLIST_IDS}; do
            echo "${id}" >> "${CONFIG_PATH}/bannedlist.txt"
        done
    fi

    # Permitted list
    if [[ -n "${PERMITTEDLIST_IDS}" ]]; then
        log_info "Writing permittedlist.txt"
        echo "// Auto-generated permitted list" > "${CONFIG_PATH}/permittedlist.txt"
        for id in ${PERMITTEDLIST_IDS}; do
            echo "${id}" >> "${CONFIG_PATH}/permittedlist.txt"
        done
    fi

    # Symlink lists to server directory if they exist
    for list in adminlist.txt bannedlist.txt permittedlist.txt; do
        if [[ -f "${CONFIG_PATH}/${list}" ]]; then
            ln -sf "${CONFIG_PATH}/${list}" "${VALHEIM_SERVER_PATH}/${list}" 2>/dev/null || true
        fi
    done
}

# -----------------------------------------------------------------------------
# SteamCMD helpers
# -----------------------------------------------------------------------------
run_steamcmd() {
    local args="$*"
    log_info "Running SteamCMD: ${args}"
    "${STEAMCMD_PATH}/steamcmd.sh" ${args}
}

get_installed_build_id() {
    local manifest="${VALHEIM_SERVER_PATH}/steamapps/appmanifest_${VALHEIM_APP_ID}.acf"
    if [[ -f "${manifest}" ]]; then
        grep -oP '"buildid"\s*"\K[^"]+' "${manifest}" 2>/dev/null || echo "0"
    else
        echo "0"
    fi
}

# -----------------------------------------------------------------------------
# Timezone setup
# -----------------------------------------------------------------------------
setup_timezone() {
    local tz="${TZ:-Etc/UTC}"
    if [[ -f "/usr/share/zoneinfo/${tz}" ]]; then
        ln -sf "/usr/share/zoneinfo/${tz}" /etc/localtime
        echo "${tz}" > /etc/timezone
        log_info "Timezone set to ${tz}"
    else
        log_warn "Invalid timezone: ${tz}, using Etc/UTC"
    fi
}

# -----------------------------------------------------------------------------
# Wait helpers
# -----------------------------------------------------------------------------
wait_for_server_ready() {
    local timeout="${1:-300}"
    local elapsed=0
    local interval=5

    log_info "Waiting for server to be ready (timeout: ${timeout}s)"

    while [[ ${elapsed} -lt ${timeout} ]]; do
        if is_server_running; then
            # Check if server is accepting connections by looking for log message
            if grep -q "Game server connected" "${LOG_PATH}/valheim-server.log" 2>/dev/null; then
                log_success "Server is ready!"
                return 0
            fi
        fi
        sleep ${interval}
        elapsed=$((elapsed + interval))
    done

    log_error "Server did not become ready within ${timeout}s"
    return 1
}
