#!/bin/bash
# =============================================================================
# Valheim Updater - Downloads and updates server files via SteamCMD
# =============================================================================

# Don't use set -e as SteamCMD often returns non-zero exit codes on warnings
# We handle errors explicitly instead

# Source common functions
if ! source /opt/valheim/scripts/common; then
    echo "[ERROR] Failed to source common functions"
    exit 1
fi

# Parse arguments
FORCE_UPDATE=false
for arg in "$@"; do
    case ${arg} in
        --force)
            FORCE_UPDATE=true
            ;;
    esac
done

# -----------------------------------------------------------------------------
# Check if update is needed
# -----------------------------------------------------------------------------
check_for_update() {
    local current_build
    current_build=$(get_installed_build_id)
    
    log_info "Current installed build ID: ${current_build}"
    
    if [[ "${current_build}" == "0" ]]; then
        log_info "No server installed, update required"
        return 0
    fi
    
    # For a full implementation, we would query Steam API for latest build
    # For now, we rely on SteamCMD's own update checking
    return 0
}

# -----------------------------------------------------------------------------
# Run update
# -----------------------------------------------------------------------------
run_update() {
    log_info "=========================================="
    log_info "Starting Valheim server update"
    log_info "=========================================="
    
    local steamcmd_args="${STEAMCMD_ARGS:-validate}"
    
    log_info "SteamCMD path: ${STEAMCMD_PATH}"
    log_info "Install directory: ${VALHEIM_SERVER_PATH}"
    log_info "App ID: ${VALHEIM_APP_ID}"
    log_info "Additional args: ${steamcmd_args}"
    
    # Ensure log directory exists
    mkdir -p "${LOG_PATH}" 2>/dev/null || true
    
    # Record start time
    local start_time
    start_time=$(date +%s)
    
    # Run SteamCMD and capture output
    local steamcmd_log="${LOG_PATH}/steamcmd.log"
    log_info "SteamCMD log: ${steamcmd_log}"
    
    # Run SteamCMD - use subshell to capture exit code properly with tee
    (
        "${STEAMCMD_PATH}/steamcmd.sh" \
            +@sSteamCmdForcePlatformType linux \
            +force_install_dir "${VALHEIM_SERVER_PATH}" \
            +login anonymous \
            +app_update "${VALHEIM_APP_ID}" ${steamcmd_args} \
            +quit
    ) 2>&1 | tee "${steamcmd_log}" || true
    
    local exit_code=${PIPESTATUS[0]}
    
    # Calculate duration
    local end_time
    end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    # SteamCMD exit codes:
    # 0 = success
    # 5 = login failure (but anonymous should work)
    # 6 = logged in elsewhere  
    # 7 = success with warnings (common for initial installs)
    # 8 = no subscription (shouldn't happen for Valheim dedicated server)
    # Other non-zero = various errors but might still have worked
    
    if [[ ${exit_code} -eq 0 ]] || [[ ${exit_code} -eq 7 ]]; then
        local new_build
        new_build=$(get_installed_build_id)
        log_success "Update completed in ${duration}s (Build: ${new_build})"
        
        # Save build ID for caching purposes
        echo "${new_build}" > "${VALHEIM_SERVER_PATH}/.build_id"
        return 0
    fi
    
    # Check if we actually got the server files despite the error code
    if [[ -f "${VALHEIM_SERVER_BINARY}" ]]; then
        log_warn "SteamCMD exited with code ${exit_code} but server binary exists"
        local new_build
        new_build=$(get_installed_build_id)
        log_success "Update completed in ${duration}s (Build: ${new_build})"
        echo "${new_build}" > "${VALHEIM_SERVER_PATH}/.build_id"
        return 0
    fi
    
    log_error "SteamCMD failed with exit code ${exit_code}"
    log_error "Check ${steamcmd_log} for details"
    return 1
}

# -----------------------------------------------------------------------------
# Main update logic
# -----------------------------------------------------------------------------
main() {
    # Check if we should skip due to active players
    if [[ "${FORCE_UPDATE}" != "true" ]]; then
        local update_if_idle="${UPDATE_IF_IDLE:-true}"
        
        if [[ "${update_if_idle,,}" == "true" ]] && is_server_running; then
            if ! is_server_idle; then
                log_info "Players are connected, skipping update (UPDATE_IF_IDLE=true)"
                return 0
            fi
        fi
    fi
    
    # Check if update is needed (or forced)
    if [[ "${FORCE_UPDATE}" == "true" ]]; then
        log_info "Forced update requested"
    else
        if ! check_for_update; then
            log_info "No update available"
            return 0
        fi
    fi
    
    # If server is running, we need to stop it first
    local was_running=false
    if is_server_running; then
        was_running=true
        log_info "Stopping server for update"
        /opt/valheim/scripts/valheim-server stop
        sleep 5
    fi
    
    # Run the update
    if run_update; then
        log_success "Update process completed"
    else
        log_error "Update process failed"
        # Try to restart server even if update failed
        if [[ "${was_running}" == "true" ]]; then
            log_info "Attempting to restart server with existing files"
            /opt/valheim/scripts/valheim-server start
        fi
        return 1
    fi
    
    # Restart server if it was running
    if [[ "${was_running}" == "true" ]]; then
        log_info "Restarting server after update"
        /opt/valheim/scripts/valheim-server start
    fi
    
    return 0
}

# Run main
main
